; PlatformIO Project Configuration File
; ESP32 Webex Status Display - Bootstrap Firmware
;
; This is a minimal bootstrap firmware that handles:
; - WiFi provisioning (AP mode + SmartConfig)
; - OTA download of the full firmware from GitHub Releases
;
; Size target: < 500KB to leave room for OTA updates
;
; Build for ESP32-S3: pio run -e esp32s3
; Build for ESP32:    pio run -e esp32

; ==============================================================================
; Version - SINGLE SOURCE OF TRUTH
; ==============================================================================
[version]
; Update this value for new releases
bootstrap_version = 1.0.6

; ==============================================================================
; Debug Settings
; ==============================================================================
; DEBUG_LEVEL: 0=Off, 1=Errors, 2=Warnings, 3=Info, 4=Debug, 5=Trace
[debug]
; DEBUG_LEVEL: 0=Off, 1=Errors, 2=Warnings, 3=Info, 4=Debug, 5=Trace (very verbose)
level = 4

; ==============================================================================
; Common settings
; ==============================================================================
[common]
lib_deps =
    ; JSON parsing
    bblanchon/ArduinoJson@^7.0.0
    ; Async Web Server
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    ; LED Matrix Display
    adafruit/Adafruit GFX Library@^1.11.0
    mrfaptastic/ESP32 HUB75 LED MATRIX PANEL DMA Display@^3.0.0
    ; mDNS support
    ; (built into ESP32 Arduino core)

build_flags_common =
    -I ../shared
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -flto
    -DDISPLAY_SIZE_ID=0
    -DBOOTSTRAP_VERSION=\"${version.bootstrap_version}\"
    -DPROJECT_VER=\"${version.bootstrap_version}\"
    -DAPP_PROJECT_VER=\"${version.bootstrap_version}\"
    -DDEFAULT_OTA_URL=\"https://display.5ls.us/updates/manifest.json\"
    -DDEBUG_LEVEL=${debug.level}

; ==============================================================================
; ESP32-S3 Environment
; ==============================================================================
[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
extra_scripts = pre:scripts/version.py, scripts/ota_bootstrap_bin.py, scripts/flash_bootstrap.py

; Board configuration for N8R2 variant (8MB Flash, 2MB PSRAM)
board_build.flash_size = 8MB
board_build.partitions = partitions_8MB_factory.csv

; Build flags
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    ; USB CDC enabled for serial output over USB
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    ; Increase loop task stack size for OTA operations
    -DARDUINO_LOOP_STACK_SIZE=16384

; Upload settings
upload_speed = 921600
monitor_speed = 115200

; Libraries
lib_deps = ${common.lib_deps}

; File system for web assets
board_build.filesystem = littlefs

; Optimization for size
build_type = release

; ==============================================================================
; ESP32 (Standard) Environment
; ==============================================================================
[env:esp32]
platform = espressif32
board = esp32dev
framework = arduino
extra_scripts = pre:scripts/version.py, scripts/ota_bootstrap_bin.py, scripts/flash_bootstrap.py

; Board configuration for standard ESP32 (4MB Flash)
board_build.flash_size = 4MB
board_build.partitions = partitions_4MB_factory.csv

; Build flags
build_flags =
    ${common.build_flags_common}
    -DESP32_STANDARD_BOARD=1
    ; Increase loop task stack size for OTA operations
    -DARDUINO_LOOP_STACK_SIZE=16384

; Upload settings
upload_speed = 921600
monitor_speed = 115200

; Libraries
lib_deps = ${common.lib_deps}

; File system for web assets
board_build.filesystem = littlefs

; Optimization for size
build_type = release
