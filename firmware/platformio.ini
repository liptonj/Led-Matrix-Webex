; PlatformIO Project Configuration File
; ESP32-S3 Webex Status Display

; ==============================================================================
; Common settings shared between environments
; ==============================================================================
[common]
build_flags_common = 
    -DMATRIX_WIDTH=64
    -DMATRIX_HEIGHT=32
    -DFIRMWARE_VERSION=\"1.0.0\"

; ==============================================================================
; ESP32-S3 Hardware Environment (default)
; ==============================================================================
[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; Board configuration for N8R2 variant (8MB Flash, 2MB PSRAM)
board_build.flash_size = 8MB
board_build.partitions = default_8MB.csv

; Build flags
build_flags = 
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1

; Upload settings
upload_speed = 921600
monitor_speed = 115200

; Libraries
lib_deps = 
    ; LED Matrix Driver and dependencies
    adafruit/Adafruit GFX Library@^1.11.0
    mrfaptastic/ESP32 HUB75 LED MATRIX PANEL DMA Display@^3.0.0
    ; JSON parsing
    bblanchon/ArduinoJson@^7.0.0
    ; Async Web Server
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    ; MQTT Client
    knolleary/PubSubClient@^2.8
    ; WebSocket Client
    links2004/WebSockets@^2.4.0
    ; HTTP Client (built-in, but declare for clarity)
    ; OTA Updates
    chrisjoyce911/esp32FOTA@^0.2.0

; File system for web assets
board_build.filesystem = littlefs

; Extra scripts for version injection
extra_scripts = 
    pre:scripts/version.py

; ==============================================================================
; Native Simulation Environment
; Run with: pio run -e native
; Execute with: .pio/build/native/program
; ==============================================================================
[env:native]
platform = native

; Include only what we need for simulation
; Excludes main.cpp (uses simulation/main_sim.cpp instead)
; Includes mock globals and necessary source files
build_src_filter = 
    +<config/>
    +<display/>
    -<main.cpp>

; Include paths: mock headers FIRST to override ESP32 headers
build_flags = 
    ${common.build_flags_common}
    -DSIMULATION_MODE=1
    -DNATIVE_BUILD=1
    -I simulation/mocks
    -I src
    -std=c++17
    -Wno-deprecated-declarations

; Extra source files for simulation
extra_scripts = 
    pre:simulation/add_sim_sources.py

; Use ArduinoJson for native (header-only library works on all platforms)
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0

; Ignore ESP32-specific libraries
lib_ignore = 
    ESP32 HUB75 LED MATRIX PANEL DMA Display
    ESPAsyncWebServer
    AsyncTCP
    PubSubClient
    WebSockets
    esp32FOTA

; ==============================================================================
; Native Test Environment
; Run tests with: pio test -e native_test
; ==============================================================================
[env:native_test]
platform = native

; Test framework
test_framework = unity

; Skip hardware-only tests that require ESP32
test_ignore = test_hardware

; Include source files for testing
; Use extra_scripts to add config sources and mock globals
test_build_src = yes
build_src_filter = 
    -<*>
    -<main.cpp>

; Add test sources via script
extra_scripts = 
    pre:scripts/add_test_sources.py

; Include paths: mock headers FIRST to override ESP32 headers
build_flags = 
    ${common.build_flags_common}
    -DSIMULATION_MODE=1
    -DNATIVE_BUILD=1
    -DUNITY_INCLUDE_DOUBLE
    -I simulation/mocks
    -I src
    -std=c++17
    -Wno-deprecated-declarations
    -Wno-format-security
    -g
    -O0

; Use ArduinoJson for native (header-only library works on all platforms)
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0
    throwtheswitch/Unity@^2.6.0

; Ignore ESP32-specific libraries
lib_ignore = 
    ESP32 HUB75 LED MATRIX PANEL DMA Display
    ESPAsyncWebServer
    AsyncTCP
    PubSubClient
    WebSockets
    esp32FOTA
    Adafruit GFX Library
