; PlatformIO Project Configuration File
; ESP32-S3 Webex Status Display

; ==============================================================================
; Version - SINGLE SOURCE OF TRUTH
; ==============================================================================
[version]
; Update this value for new releases
firmware_version = 1.1.9

; ==============================================================================
; Common settings shared between environments
; ==============================================================================
[common]
build_flags_common =
    -I ../shared
    -DDISPLAY_SIZE_ID=0
    -DFIRMWARE_VERSION=\"${version.firmware_version}\"
    -DPROJECT_VER=\"${version.firmware_version}\"
    -DAPP_PROJECT_VER=\"${version.firmware_version}\"

; ==============================================================================
; Common hardware settings
; ==============================================================================
[common_hw]
lib_deps =
    ; LED Matrix Driver and dependencies
    adafruit/Adafruit GFX Library@^1.11.0
    mrfaptastic/ESP32 HUB75 LED MATRIX PANEL DMA Display@^3.0.0
    ; JSON parsing
    bblanchon/ArduinoJson@^7.0.0
    ; Async Web Server
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    ; MQTT Client
    knolleary/PubSubClient@^2.8
    ; WebSocket Client
    links2004/WebSockets@^2.4.0
    ; OTA Updates
    chrisjoyce911/esp32FOTA@^0.2.0

; Module IDs (bitmask)
; MODULE_CORE           = 0x01
; MODULE_WEBEX_POLLING  = 0x02
; MODULE_MQTT_SENSORS   = 0x04
; MODULE_BRIDGE_CLIENT  = 0x08
; MODULE_XAPI_CLIENT    = 0x10
; MODULE_EMBEDDED_APP   = 0x20

; Common ESP32-S3 settings
[esp32s3_common]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
board_build.flash_size = 8MB
board_build.partitions = partitions_8MB_factory.csv
board_build.filesystem = littlefs
upload_speed = 921600
monitor_speed = 115200
extra_scripts = pre:scripts/version.py, scripts/upload_all.py, scripts/ota_bin.py

; Base library dependencies (always included)
lib_deps_base =
    adafruit/Adafruit GFX Library@^1.11.0
    mrfaptastic/ESP32 HUB75 LED MATRIX PANEL DMA Display@^3.0.0
    bblanchon/ArduinoJson@^7.0.0
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    chrisjoyce911/esp32FOTA@^0.2.0

; Optional module libraries
lib_deps_mqtt = knolleary/PubSubClient@^2.8
lib_deps_websocket = links2004/WebSockets@^2.4.0

; ==============================================================================
; ESP32-S3 Full Build (all modules) - Default
; ==============================================================================
[env:esp32s3]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://display.5ls.us/updates/manifest.json\"
    -DDEFAULT_OTA_MANIFEST_URL=\"https://display.5ls.us/updates/manifest.json\"
    ; All modules enabled
    -DINSTALLED_MODULES=0x3F
    -DMODULE_WEBEX_POLLING_ENABLED=1
    -DMODULE_MQTT_SENSORS_ENABLED=1
    -DMODULE_BRIDGE_CLIENT_ENABLED=1
    -DMODULE_XAPI_CLIENT_ENABLED=1
    -DMODULE_EMBEDDED_APP_ENABLED=1

lib_deps =
    ${esp32s3_common.lib_deps_base}
    ${esp32s3_common.lib_deps_mqtt}
    ${esp32s3_common.lib_deps_websocket}

; ==============================================================================
; ESP32 (Standard) Hardware Environment
; Use with: pio run -e esp32
; ==============================================================================
[env:esp32]
platform = espressif32
board = esp32dev
framework = arduino

; Board configuration for standard ESP32 (4MB Flash)
board_build.flash_size = 4MB
board_build.partitions = partitions_4MB_factory.csv
board_build.filesystem = littlefs

; Build flags
build_flags =
    ${common.build_flags_common}
    -DESP32_STANDARD_BOARD=1
    -DDEFAULT_OTA_URL=\"https://display.5ls.us/updates/manifest.json\"
    -DDEFAULT_OTA_MANIFEST_URL=\"https://display.5ls.us/updates/manifest.json\"
    ; All modules enabled
    -DINSTALLED_MODULES=0x3F
    -DMODULE_WEBEX_POLLING_ENABLED=1
    -DMODULE_MQTT_SENSORS_ENABLED=1
    -DMODULE_BRIDGE_CLIENT_ENABLED=1
    -DMODULE_XAPI_CLIENT_ENABLED=1
    -DMODULE_EMBEDDED_APP_ENABLED=1

; Upload settings
upload_speed = 921600
monitor_speed = 115200

; Libraries
lib_deps = ${common_hw.lib_deps}

; Extra scripts for version injection
extra_scripts =
    pre:scripts/version.py
    scripts/upload_all.py
    scripts/ota_bin.py

; ==============================================================================
; Minimal Build - Core only (WiFi, Display, Web Server, OTA)
; Smallest possible firmware for initial bootstrap
; ==============================================================================
[env:minimal]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://api.github.com/repos/liptonj/Led-Matrix-Webex/releases/latest\"
    ; Core only
    -DINSTALLED_MODULES=0x01

lib_deps = ${esp32s3_common.lib_deps_base}

build_src_filter =
    +<*>
    -<webex/>
    -<meraki/>
    -<bridge/>

; ==============================================================================
; Embedded Build - Core + Embedded App
; Webex embedded app for status control, no background polling
; ==============================================================================
[env:embedded]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://api.github.com/repos/liptonj/Led-Matrix-Webex/releases/latest\"
    ; Core + Embedded App
    -DINSTALLED_MODULES=0x21
    -DMODULE_EMBEDDED_APP_ENABLED=1

lib_deps = ${esp32s3_common.lib_deps_base}

build_src_filter =
    +<*>
    -<webex/>
    -<meraki/>
    -<bridge/>

; ==============================================================================
; Standard Build - Core + Embedded App + Webex Polling
; Most common configuration for direct Webex integration
; ==============================================================================
[env:standard]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://api.github.com/repos/liptonj/Led-Matrix-Webex/releases/latest\"
    ; Core + Embedded App + Webex Polling
    -DINSTALLED_MODULES=0x23
    -DMODULE_EMBEDDED_APP_ENABLED=1
    -DMODULE_WEBEX_POLLING_ENABLED=1

lib_deps = ${esp32s3_common.lib_deps_base}

build_src_filter =
    +<*>
    -<meraki/>
    -<bridge/>

; ==============================================================================
; Sensors Build - Core + Embedded App + MQTT Sensors
; For Meraki MT sensor integration
; ==============================================================================
[env:sensors]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://api.github.com/repos/liptonj/Led-Matrix-Webex/releases/latest\"
    ; Core + Embedded App + MQTT Sensors
    -DINSTALLED_MODULES=0x25
    -DMODULE_EMBEDDED_APP_ENABLED=1
    -DMODULE_MQTT_SENSORS_ENABLED=1

lib_deps =
    ${esp32s3_common.lib_deps_base}
    ${esp32s3_common.lib_deps_mqtt}

build_src_filter =
    +<*>
    -<webex/>
    -<bridge/>

; ==============================================================================
; Bridge Build - Core + Embedded App + Bridge Client
; For Node.js bridge server integration
; ==============================================================================
[env:bridge]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://api.github.com/repos/liptonj/Led-Matrix-Webex/releases/latest\"
    ; Core + Embedded App + Bridge Client
    -DINSTALLED_MODULES=0x29
    -DMODULE_EMBEDDED_APP_ENABLED=1
    -DMODULE_BRIDGE_CLIENT_ENABLED=1

lib_deps =
    ${esp32s3_common.lib_deps_base}
    ${esp32s3_common.lib_deps_websocket}

build_src_filter =
    +<*>
    -<webex/>
    -<meraki/>

; ==============================================================================
; Native Simulation Environment
; Run with: pio run -e native
; Execute with: .pio/build/native/program
; ==============================================================================
[env:native]
platform = native

; Include only what we need for simulation
; Excludes main.cpp (uses simulation/main_sim.cpp instead)
; Includes mock globals and necessary source files
build_src_filter =
    +<config/>
    +<display/>
    -<main.cpp>

; Include paths: mock headers FIRST to override ESP32 headers
build_flags =
    ${common.build_flags_common}
    -DSIMULATION_MODE=1
    -DNATIVE_BUILD=1
    -I simulation/mocks
    -I src
    -std=c++17
    -Wno-deprecated-declarations

; Extra source files for simulation
extra_scripts =
    pre:simulation/add_sim_sources.py

; Use ArduinoJson for native (header-only library works on all platforms)
lib_deps =
    bblanchon/ArduinoJson@^7.0.0

; Ignore ESP32-specific libraries
lib_ignore =
    ESP32 HUB75 LED MATRIX PANEL DMA Display
    ESPAsyncWebServer
    AsyncTCP
    PubSubClient
    WebSockets
    esp32FOTA

; ==============================================================================
; Native Test Environment
; Run tests with: pio test -e native_test
; ==============================================================================
[env:native_test]
platform = native

; Test framework
test_framework = unity

; Skip hardware-only tests that require ESP32
test_ignore = test_hardware

; Include source files for testing
; Use extra_scripts to add config sources and mock globals
test_build_src = yes
build_src_filter =
    -<*>
    -<main.cpp>

; Add test sources via script
extra_scripts =
    pre:scripts/add_test_sources.py

; Include paths: mock headers FIRST to override ESP32 headers
build_flags =
    ${common.build_flags_common}
    -DSIMULATION_MODE=1
    -DNATIVE_BUILD=1
    -DUNITY_INCLUDE_DOUBLE
    -I simulation/mocks
    -I src
    -std=c++17
    -Wno-deprecated-declarations
    -Wno-format-security
    -g
    -O0

; Use ArduinoJson for native (header-only library works on all platforms)
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    throwtheswitch/Unity@^2.6.0

; Ignore ESP32-specific libraries
lib_ignore =
    ESP32 HUB75 LED MATRIX PANEL DMA Display
    ESPAsyncWebServer
    AsyncTCP
    PubSubClient
    WebSockets
    esp32FOTA
    Adafruit GFX Library
