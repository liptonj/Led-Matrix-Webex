; PlatformIO Project Configuration File
; ESP32-S3 Webex Status Display
;
; ==============================================================================
; Partition Layout (8MB) - Dual OTA
; ==============================================================================
; Web installer flashes to ota_0. OTA updates alternate between ota_0/ota_1
; for A/B update support with automatic rollback on failure.
;
; Partition Layout:
;   ota_0   (0x10000)  - Primary firmware (~3.5MB)
;   ota_1   (0x380000) - Alternate OTA slot (~3.5MB)
;   spiffs  (0x6F0000) - LittleFS filesystem (not used, web assets embedded)
; ==============================================================================

; ==============================================================================
; Version - SINGLE SOURCE OF TRUTH
; ==============================================================================
[version]
; Update this value for new releases
firmware_version = 2.0.2

; ==============================================================================
; Common settings shared between environments
; ==============================================================================
[common]
; Supabase configuration is loaded from environment variables.
; For local development: copy .env.example to .env and fill in your values.
; For CI: secrets are set via GitHub Actions environment variables.
; The load_env.py script loads .env automatically during build.

build_flags_common =
    -I ../shared
    -DDISPLAY_SIZE_ID=0
    -DFIRMWARE_VERSION=\"${version.firmware_version}\"
    -DPROJECT_VER=\"${version.firmware_version}\"
    -DAPP_PROJECT_VER=\"${version.firmware_version}\"

; ==============================================================================
; Common hardware settings
; ==============================================================================
[common_hw]
lib_deps =
    ; LED Matrix Driver and dependencies
    adafruit/Adafruit GFX Library@^1.11.0
    mrfaptastic/ESP32 HUB75 LED MATRIX PANEL DMA Display@^3.0.0
    ; JSON parsing
    bblanchon/ArduinoJson@^7.0.0
    ; Async Web Server
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    ; MQTT Client
    knolleary/PubSubClient@^2.8
    ; WebSocket Client (for xAPI)
    links2004/WebSockets@^2.4.0

; Module IDs (bitmask)
; MODULE_CORE           = 0x01
; MODULE_WEBEX_POLLING  = 0x02
; MODULE_MQTT_SENSORS   = 0x04
; MODULE_XAPI_CLIENT    = 0x10
; MODULE_EMBEDDED_APP   = 0x20

; Common ESP32-S3 settings
[esp32s3_common]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
board_build.flash_size = 8MB
board_build.partitions = partitions_8MB.csv
board_build.filesystem = littlefs
upload_speed = 921600
monitor_speed = 115200
extra_scripts = pre:scripts/load_env.py, pre:scripts/version.py, pre:scripts/embed_web_assets.py, scripts/upload_all.py, scripts/ota_bin.py

; Base library dependencies (always included)
lib_deps_base =
    adafruit/Adafruit GFX Library@^1.11.0
    mrfaptastic/ESP32 HUB75 LED MATRIX PANEL DMA Display@^3.0.0
    bblanchon/ArduinoJson@^7.0.0
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    jnthas/Improv WiFi Library@^0.0.4

; Optional module libraries
lib_deps_mqtt = knolleary/PubSubClient@^2.8
; WebSocket library for xAPI client (local device connections)
lib_deps_websocket = links2004/WebSockets@^2.4.0

; ==============================================================================
; ESP32-S3 Full Build (all modules) - Default
; ==============================================================================
[env:esp32s3]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://fmultmlsevqgtnqzaylg.supabase.co/functions/v1/get-manifest\"
    -DDEFAULT_OTA_MANIFEST_URL=\"https://fmultmlsevqgtnqzaylg.supabase.co/functions/v1/get-manifest\"
    ; All modules enabled
    -DINSTALLED_MODULES=0x37
    -DMODULE_WEBEX_POLLING_ENABLED=1
    -DMODULE_MQTT_SENSORS_ENABLED=1
    -DMODULE_XAPI_CLIENT_ENABLED=1
    -DMODULE_EMBEDDED_APP_ENABLED=1

lib_deps =
    ${esp32s3_common.lib_deps_base}
    ${esp32s3_common.lib_deps_mqtt}
    ${esp32s3_common.lib_deps_websocket}

; ==============================================================================
; ESP32 (Standard 4MB) - REMOVED
; 4MB ESP32 support has been dropped in favor of 8MB ESP32-S3 only.
; Web assets are now embedded in firmware, requiring more flash space.
; ==============================================================================

; ==============================================================================
; Minimal Build - Core only (WiFi, Display, Web Server, OTA)
; Smallest possible firmware for initial bootstrap
; ==============================================================================
[env:minimal]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://fmultmlsevqgtnqzaylg.supabase.co/functions/v1/get-manifest\"
    ; Core only
    -DINSTALLED_MODULES=0x01

lib_deps = ${esp32s3_common.lib_deps_base}

build_src_filter =
    +<*>
    -<webex/>
    -<meraki/>

; ==============================================================================
; Embedded Build - Core + Embedded App
; Webex embedded app for status control, no background polling
; ==============================================================================
[env:embedded]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://fmultmlsevqgtnqzaylg.supabase.co/functions/v1/get-manifest\"
    ; Core + Embedded App
    -DINSTALLED_MODULES=0x21
    -DMODULE_EMBEDDED_APP_ENABLED=1

lib_deps = ${esp32s3_common.lib_deps_base}

build_src_filter =
    +<*>
    -<webex/>
    -<meraki/>

; ==============================================================================
; Standard Build - Core + Embedded App + Webex Polling
; Most common configuration for direct Webex integration
; ==============================================================================
[env:standard]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://fmultmlsevqgtnqzaylg.supabase.co/functions/v1/get-manifest\"
    ; Core + Embedded App + Webex Polling
    -DINSTALLED_MODULES=0x23
    -DMODULE_EMBEDDED_APP_ENABLED=1
    -DMODULE_WEBEX_POLLING_ENABLED=1

lib_deps = ${esp32s3_common.lib_deps_base}

build_src_filter =
    +<*>
    -<meraki/>

; ==============================================================================
; Sensors Build - Core + Embedded App + MQTT Sensors
; For Meraki MT sensor integration
; ==============================================================================
[env:sensors]
extends = esp32s3_common
build_flags =
    ${common.build_flags_common}
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DESP32_S3_BOARD=1
    -DDEFAULT_OTA_URL=\"https://fmultmlsevqgtnqzaylg.supabase.co/functions/v1/get-manifest\"
    ; Core + Embedded App + MQTT Sensors
    -DINSTALLED_MODULES=0x25
    -DMODULE_EMBEDDED_APP_ENABLED=1
    -DMODULE_MQTT_SENSORS_ENABLED=1

lib_deps =
    ${esp32s3_common.lib_deps_base}
    ${esp32s3_common.lib_deps_mqtt}

build_src_filter =
    +<*>
    -<webex/>

; ==============================================================================
; Native Simulation Environment
; Run with: pio run -e native
; Execute with: .pio/build/native/program
; ==============================================================================
[env:native]
platform = native

; Include only what we need for simulation
; Excludes main.cpp (uses simulation/main_sim.cpp instead)
; Includes mock globals and necessary source files
build_src_filter =
    +<config/>
    +<display/>
    -<main.cpp>

; Include paths: mock headers FIRST to override ESP32 headers
build_flags =
    ${common.build_flags_common}
    -DSIMULATION_MODE=1
    -DNATIVE_BUILD=1
    -I simulation/mocks
    -I src
    -std=c++17
    -Wno-deprecated-declarations

; Extra source files for simulation
extra_scripts =
    pre:simulation/add_sim_sources.py

; Use ArduinoJson for native (header-only library works on all platforms)
lib_deps =
    bblanchon/ArduinoJson@^7.0.0

; Ignore ESP32-specific libraries
lib_ignore =
    ESP32 HUB75 LED MATRIX PANEL DMA Display
    ESPAsyncWebServer
    AsyncTCP
    PubSubClient
    WebSockets

; ==============================================================================
; Native Test Environment
; Run tests with: pio test -e native_test
; ==============================================================================
[env:native_test]
platform = native

; Test framework
test_framework = unity

; Skip hardware-only tests that require ESP32
test_ignore = test_hardware

; Include source files for testing
; Use extra_scripts to add config sources and mock globals
test_build_src = yes
build_src_filter =
    -<*>
    -<main.cpp>

; Add test sources via script
extra_scripts =
    pre:scripts/add_test_sources.py

; Include paths: mock headers FIRST to override ESP32 headers
build_flags =
    ${common.build_flags_common}
    -DSIMULATION_MODE=1
    -DNATIVE_BUILD=1
    -DUNITY_INCLUDE_DOUBLE
    -I simulation/mocks
    -I src
    -std=c++17
    -Wno-deprecated-declarations
    -Wno-format-security
    -g
    -O0

; Use ArduinoJson for native (header-only library works on all platforms)
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    throwtheswitch/Unity@^2.6.0

; Ignore ESP32-specific libraries
lib_ignore =
    ESP32 HUB75 LED MATRIX PANEL DMA Display
    ESPAsyncWebServer
    AsyncTCP
    PubSubClient
    WebSockets
    Adafruit GFX Library
