# Supabase Upload Location Verification

## Verification Date
January 28, 2026

## Upload Endpoint Format

### CI Workflow Upload
```bash
POST ${SUPABASE_URL}/storage/v1/object/firmware/${VERSION}/firmware.bin
POST ${SUPABASE_URL}/storage/v1/object/firmware/${VERSION}/firmware-merged.bin
```

### Supabase Storage API Format
According to Supabase documentation:
```
POST /storage/v1/object/{bucketName}/{wildcard}
```

Where:
- `{bucketName}` = bucket name (e.g., `firmware`)
- `{wildcard}` = file path within bucket (e.g., `1.5.3/firmware.bin`)

**Status**: ✅ **FORMAT IS CORRECT**

## Path Structure Verification

### Upload Paths (CI Workflow)
- OTA Firmware: `firmware/1.5.3/firmware.bin`
- Merged Firmware: `firmware/1.5.3/firmware-merged.bin`

### Expected Paths (Edge Functions)

#### get-firmware function (line 109)
```typescript
const filePath = `${release.version}/firmware.bin`;
// Example: "1.5.3/firmware.bin"
await supabase.storage.from("firmware").createSignedUrl(filePath, ...)
```

#### get-manifest function (line 160)
```typescript
const firmwarePath = `${latestRelease.version}/firmware-merged.bin`;
// Example: "1.5.3/firmware-merged.bin"
await supabase.storage.from("firmware").createSignedUrl(firmwarePath, ...)
```

**Status**: ✅ **PATHS MATCH PERFECTLY**

## Bucket Configuration

### Bucket Name
- **CI Upload**: `firmware`
- **Migration**: `firmware` (line 146 in `20260127000000_create_display_schema.sql`)
- **Edge Functions**: `from("firmware")`
- **Status**: ✅ **ALL MATCH**

### Bucket Properties
- **Public**: `false` (private bucket)
- **Access**: Via signed URLs generated by Edge Functions
- **Status**: ✅ **CONFIGURED CORRECTLY**

## Storage URL Format in Release Record

### CI Workflow Stores
```json
{
  "firmware_url": "${SUPABASE_URL}/storage/v1/object/firmware/${VERSION}/firmware.bin",
  "firmware_merged_url": "${SUPABASE_URL}/storage/v1/object/firmware/${VERSION}/firmware-merged.bin"
}
```

### Edge Functions Use
The Edge Functions don't use these URLs directly. Instead, they:
1. Read the `version` from the release record
2. Construct the path: `{version}/firmware.bin`
3. Generate a signed URL using `supabase.storage.from("firmware").createSignedUrl()`

**Status**: ✅ **CORRECT** (URLs stored for reference, but Edge Functions generate signed URLs)

## Complete Flow Verification

### 1. Upload Flow
```
CI Workflow
  ↓
POST /storage/v1/object/firmware/1.5.3/firmware.bin
  ↓
Supabase Storage
  ↓
File stored at: firmware bucket → 1.5.3/firmware.bin
```

### 2. Download Flow
```
Device requests firmware
  ↓
Edge Function: get-firmware
  ↓
Reads version from display.releases table
  ↓
Constructs path: {version}/firmware.bin (e.g., "1.5.3/firmware.bin")
  ↓
Generates signed URL: supabase.storage.from("firmware").createSignedUrl("1.5.3/firmware.bin")
  ↓
Returns signed URL to device
  ↓
Device downloads from signed URL
```

**Status**: ✅ **FLOW IS CORRECT**

## Verification Checklist

- [x] Upload endpoint format matches Supabase API specification
- [x] Bucket name is correct (`firmware`)
- [x] Path structure matches Edge Function expectations
- [x] File paths are consistent across CI and Edge Functions
- [x] Storage URLs stored in release record are correct format
- [x] Edge Functions can access files using the same path structure

## Test Verification

To verify uploads are going to the correct location:

### 1. Check Upload Response
The CI workflow should receive HTTP 200-299 on successful upload.

### 2. Verify File Exists
After upload, verify file exists in Supabase Storage:
- Go to Supabase Dashboard → Storage → firmware bucket
- Check for folder: `1.5.3/`
- Verify files: `firmware.bin` and `firmware-merged.bin`

### 3. Test Edge Function Access
```bash
# Test get-firmware function (requires HMAC auth)
curl "${SUPABASE_URL}/functions/v1/get-firmware?version=1.5.3" \
  -H "X-Device-Serial: TEST1234" \
  -H "X-Timestamp: $(date +%s)" \
  -H "X-Signature: <hmac-signature>"
```

Should return a signed URL that points to the uploaded file.

## Summary

✅ **All upload configurations are verified and correct**

- Upload endpoint format: ✅ Correct
- Bucket name: ✅ Matches (`firmware`)
- Path structure: ✅ Matches Edge Function expectations
- File locations: ✅ Consistent across CI and Edge Functions
- Storage URLs: ✅ Correct format stored in release records

**Conclusion**: Files are being uploaded to the correct location and Edge Functions can access them using the same path structure.
