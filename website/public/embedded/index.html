<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Matrix Display - Webex Embedded App</title>
    <link rel="stylesheet" href="style.css">
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="../icon-512.png" alt="LED Matrix Display" class="app-logo">
                <h1>LED Matrix Display</h1>
            </div>
            <div class="status-indicator" id="connection-status">
                <span class="dot"></span>
                <span class="text">Connecting...</span>
            </div>
        </header>

        <!-- Setup Screen (shown when no display configured) -->
        <section id="setup-screen" class="screen">
            <div class="card setup-card">
                <h2>Connect to Your Display</h2>
                <p class="help-text">Connect via WebSocket bridge for real-time status sync.</p>
                
                <!-- Connection Mode Selector -->
                <div class="connection-mode-tabs">
                    <button class="mode-btn active" data-mode="bridge" id="mode-bridge-btn">Bridge (Recommended)</button>
                    <button class="mode-btn" data-mode="direct" id="mode-direct-btn">Direct HTTP</button>
                </div>
                
                <!-- Bridge Connection Mode -->
                <div id="bridge-mode" class="connection-mode active">
                    <div class="form-group">
                        <label for="bridge-url">Bridge URL: <span id="bridge-url-status" class="auto-discovered"></span></label>
                        <input type="text" id="bridge-url" placeholder="Loading...">
                        <p class="help-text">Auto-discovered from server. Override with local URL if needed (e.g., ws://homeassistant.local:8080)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="pairing-code">Pairing Code:</label>
                        <input type="text" id="pairing-code" placeholder="e.g., ABC123" maxlength="6" style="text-transform: uppercase;">
                        <p class="help-text">6-character code shown on your LED display</p>
                    </div>
                    
                    <button id="connect-bridge-btn" class="btn btn-primary btn-large">Connect via Bridge</button>
                </div>
                
                <!-- Direct Connection Mode -->
                <div id="direct-mode" class="connection-mode" style="display: none;">
                    <div class="form-group">
                        <label for="display-address">Display Address:</label>
                        <input type="text" id="display-address" placeholder="e.g., 192.168.1.100 or webex-display.local">
                        <p class="help-text">Direct HTTP connection (may not work in Webex iframe)</p>
                    </div>
                    
                    <button id="connect-btn" class="btn btn-primary btn-large">Connect Directly</button>
                </div>
                
                <div id="connection-error" class="error-message" style="display: none;"></div>
                
                <!-- Clear saved pairing button (shown when there's a saved pairing) -->
                <div id="clear-pairing-section" class="clear-pairing-section" style="display: none;">
                    <p class="help-text">Having trouble connecting? Your display may have a new pairing code.</p>
                    <button id="clear-pairing-btn" class="btn btn-warning">Clear Saved Pairing</button>
                </div>
                
                <div class="setup-help">
                    <h3>Bridge Connection (Recommended):</h3>
                    <ol>
                        <li>Install the Webex Bridge add-on in Home Assistant</li>
                        <li>Expose via Cloudflare Tunnel (e.g., <code>wss://bridge.yourdomain.com</code>)</li>
                        <li>Your LED display will show a 6-character pairing code</li>
                        <li>Enter the bridge URL and pairing code above</li>
                    </ol>
                    <p class="help-text" style="margin-top: 8px;">
                        <strong>Tip:</strong> Use <code>wss://</code> for Cloudflare tunnel, <code>ws://</code> for local network.
                    </p>
                </div>
            </div>
        </section>

        <!-- Main App Screen (shown after display connected) -->
        <section id="main-screen" class="screen" style="display: none;">
            <!-- Tab Navigation -->
            <nav class="tabs">
                <button class="tab-btn active" data-tab="status">Status</button>
                <button class="tab-btn" data-tab="display">Display</button>
                <button class="tab-btn" data-tab="webex">Webex</button>
                <button class="tab-btn" data-tab="system">System</button>
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <!-- ==================== STATUS TAB ==================== -->
                <section id="status" class="tab-content active">
                    <!-- User Info Section -->
                    <div class="card user-info">
                        <h2>Your Webex Status</h2>
                        <div class="presence-display" id="presence-container">
                            <div class="presence-avatar" id="presence-avatar">
                                <span class="initial" id="user-initial">?</span>
                            </div>
                            <div class="presence-details">
                                <span class="name" id="user-name">Loading...</span>
                                <span class="status" id="user-status">--</span>
                            </div>
                        </div>
                        
                        <!-- Meeting Detection Status -->
                        <div class="meeting-status" id="meeting-status" style="display: none;">
                            <span class="icon">üìû</span>
                            <span class="text">In a meeting - auto-detected</span>
                        </div>
                        
                        <!-- Manual Status Selection -->
                        <div class="status-selector">
                            <h3>Set Your Status</h3>
                            <div class="status-buttons" id="status-buttons">
                                <button class="status-btn available" data-status="active" title="Available">
                                    <span class="dot"></span>
                                    <span>Available</span>
                                </button>
                                <button class="status-btn away" data-status="away" title="Away">
                                    <span class="dot"></span>
                                    <span>Away</span>
                                </button>
                                <button class="status-btn busy" data-status="meeting" title="In a Call">
                                    <span class="dot"></span>
                                    <span>In a Call</span>
                                </button>
                                <button class="status-btn dnd" data-status="dnd" title="Do Not Disturb">
                                    <span class="dot"></span>
                                    <span>DND</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Camera/Mic Toggles -->
                        <div class="hardware-toggles">
                            <h3>Camera & Microphone</h3>
                            <p class="help-text">Mic state auto-updates during calls. Camera is manual (SDK limitation).</p>
                            <div class="toggle-buttons">
                                <button id="camera-toggle" class="toggle-btn" data-active="false" title="Camera state must be set manually - not available from Webex SDK">
                                    <span class="icon" id="camera-icon">üì∑</span>
                                    <span class="label" id="camera-label">Camera Off</span>
                                </button>
                                <button id="mic-toggle" class="toggle-btn" data-active="true" title="Auto-detected during calls, or toggle manually">
                                    <span class="icon" id="mic-icon">üé§</span>
                                    <span class="label" id="mic-label">Mic On</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="sync-status" id="sync-status">
                            <span class="icon">‚è≥</span>
                            <span class="text">Waiting to sync...</span>
                        </div>
                    </div>

                    <!-- Current Display Status -->
                    <div class="card">
                        <h2>Display Status</h2>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="label">Current Status:</span>
                                <span id="display-status" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Camera:</span>
                                <span id="camera-status" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Microphone:</span>
                                <span id="mic-status" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">In Call:</span>
                                <span id="call-status" class="value">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="card activity-section">
                        <h2>Activity Log</h2>
                        <div class="activity-log" id="activity-log">
                            <div class="log-entry">
                                <span class="time">--:--:--</span>
                                <span class="message">Initializing...</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ==================== DISPLAY TAB ==================== -->
                <section id="display" class="tab-content">
                    <div class="card">
                        <h2>Display Settings</h2>
                        <form id="display-form">
                            <div class="form-group">
                                <label for="device-name">Device Name:</label>
                                <input type="text" id="device-name" placeholder="webex-display">
                                <p class="help-text">Used for mDNS hostname (e.g., webex-display.local)</p>
                            </div>
                            <div class="form-group">
                                <label for="display-name">Your Name:</label>
                                <input type="text" id="display-name" placeholder="John Doe">
                                <p class="help-text">Displayed on the LED matrix</p>
                            </div>
                            <div class="form-group">
                                <label for="brightness">Brightness: <span id="brightness-value">128</span></label>
                                <input type="range" id="brightness" min="10" max="255" value="128">
                            </div>
                            <div class="form-group">
                                <label for="poll-interval">Status Poll Interval (seconds):</label>
                                <input type="number" id="poll-interval" min="20" max="300" value="30">
                                <p class="help-text">How often to check Webex status (min 20s)</p>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Display Settings</button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Connected Display</h2>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="label">Address:</span>
                                <span id="display-host" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">IP Address:</span>
                                <span id="ip-address" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Firmware:</span>
                                <span id="firmware-version" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Uptime:</span>
                                <span id="uptime" class="value">--</span>
                            </div>
                        </div>
                        <button id="disconnect-display" class="btn btn-warning">Disconnect Display</button>
                    </div>
                </section>

                <!-- ==================== WEBEX TAB ==================== -->
                <section id="webex" class="tab-content">
                    <div class="card">
                        <h2>Webex OAuth Configuration</h2>
                        <p class="help-text">Configure OAuth credentials from <a href="https://developer.webex.com/my-apps" target="_blank">developer.webex.com</a></p>
                        <form id="webex-form">
                            <div class="form-group">
                                <label for="webex-client-id">Client ID:</label>
                                <input type="text" id="webex-client-id" placeholder="Your Webex Integration Client ID">
                            </div>
                            <div class="form-group">
                                <label for="webex-client-secret">Client Secret:</label>
                                <input type="password" id="webex-client-secret" placeholder="Your Webex Integration Client Secret">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Credentials</button>
                        </form>
                        <hr>
                        <div class="auth-section">
                            <h3>Authorization Status</h3>
                            <p>Status: <span id="webex-auth-status" class="value">Not connected</span></p>
                            <button id="webex-auth-btn" class="btn">Connect to Webex</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Embedded App Settings</h2>
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" id="auto-sync" checked>
                                <span>Auto-sync status changes to display</span>
                            </label>
                        </div>
                        <p class="help-text">When enabled, status changes are immediately pushed to the display.</p>
                    </div>
                </section>

                <!-- ==================== SYSTEM TAB ==================== -->
                <section id="system" class="tab-content">
                    <div class="card">
                        <h2>System Information</h2>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="label">Firmware Version:</span>
                                <span id="sys-firmware-version" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Build ID:</span>
                                <span id="firmware-build-id" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Free Memory:</span>
                                <span id="free-heap" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">WiFi Signal:</span>
                                <span id="wifi-signal" class="value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>WiFi Configuration</h2>
                        <button id="scan-wifi" class="btn">Scan Networks</button>
                        <div id="wifi-networks" class="network-list"></div>
                        <form id="wifi-form">
                            <div class="form-group">
                                <label for="wifi-ssid">SSID:</label>
                                <input type="text" id="wifi-ssid" placeholder="WiFi network name">
                            </div>
                            <div class="form-group">
                                <label for="wifi-password">Password:</label>
                                <input type="password" id="wifi-password" placeholder="WiFi password">
                            </div>
                            <button type="submit" class="btn btn-primary">Save & Connect</button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Firmware Update</h2>
                        <div class="status-grid" style="margin-bottom: 15px;">
                            <div class="status-item">
                                <span class="label">Current:</span>
                                <span id="current-version" class="value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Latest:</span>
                                <span id="latest-version" class="value">--</span>
                            </div>
                        </div>
                        <button id="check-update" class="btn">Check for Updates</button>
                        <button id="perform-update" class="btn btn-warning" disabled>Install Update</button>
                    </div>

                    <div class="card danger-zone">
                        <h2>Danger Zone</h2>
                        <p class="help-text">These actions cannot be undone.</p>
                        <button id="reboot-btn" class="btn btn-warning">Reboot Device</button>
                        <button id="factory-reset-btn" class="btn btn-danger">Factory Reset</button>
                    </div>
                </section>
            </main>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <span>LED Matrix Webex Display</span>
            <span class="version" id="app-version">v1.1.16</span>
        </footer>
    </div>

    <!-- Webex Embedded Apps SDK v2 -->
    <script src="https://binaries.webex.com/static-content-pipeline/webex-embedded-app/v1/webex-embedded-app-sdk.js"></script>
    <script src="app.js"></script>
</body>
</html>
