name: Deploy Website to Cloudflare Pages

# This workflow is for manual re-deployments only.
# Normal deployments happen via ci.yml when a version tag is pushed.
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual re-deployment'

jobs:
  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        working-directory: website
        run: npm ci

      - name: Create firmware directory
        run: mkdir -p website/public/updates/firmware

      - name: Download firmware from latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Downloading firmware binaries from latest release..."

          # Get latest release tag
          LATEST_TAG=$(gh release view --json tagName -q '.tagName' 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No releases found, skipping firmware download"
            exit 0
          fi

          echo "Latest release: $LATEST_TAG"

          # Download firmware binaries
          cd website/public/updates/firmware

          # Main firmware for OTA updates (ESP32-S3 only, web assets embedded)
          gh release download "$LATEST_TAG" --pattern "firmware-esp32s3.bin" --clobber || echo "firmware-esp32s3.bin not found"

          # Merged firmware for web installer (includes bootloader, partition table, boot_app0)
          gh release download "$LATEST_TAG" --pattern "firmware-merged-esp32s3.bin" --clobber || echo "firmware-merged-esp32s3.bin not found"

          # Create copies with build ID for cache busting (ESP Web Tools uses these)
          BUILD_ID=$(date +%s)
          echo "BUILD_ID=${BUILD_ID}" >> $GITHUB_ENV
          
          if [ -f "firmware-esp32s3.bin" ]; then
            cp firmware-esp32s3.bin "firmware-esp32s3-${BUILD_ID}.bin"
            echo "Created build copy: firmware-esp32s3-${BUILD_ID}.bin"
          fi
          if [ -f "firmware-merged-esp32s3.bin" ]; then
            cp firmware-merged-esp32s3.bin "firmware-merged-esp32s3-${BUILD_ID}.bin"
            echo "Created build copy: firmware-merged-esp32s3-${BUILD_ID}.bin"
          fi

          echo "Downloaded firmware files:"
          ls -la

      - name: Build website
        working-directory: website
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_ID: ${{ env.BUILD_ID }}
        run: |
          echo "Using BUILD_ID: $BUILD_ID for cache busting"
          npm run build

      - name: Verify build output
        run: |
          echo "Build output contents:"
          ls -la website/out/
          echo ""
          echo "Pages generated:"
          find website/out -name "index.html" | head -20

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: led-matrix-webex
          directory: website/out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          wranglerVersion: '3'
