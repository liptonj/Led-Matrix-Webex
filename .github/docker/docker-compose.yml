# GitHub Actions Self-Hosted Runners for Led-Matrix-Webex
# Runs 7 parallel runners in Docker containers
#
# CURRENT HOST: 4 CPU cores, 8 GB RAM
# With these resources, only 3-4 jobs can run simultaneously
# Consider reducing to 4 runners total if you want fewer idle containers
#
# Usage:
#   cd .github/docker
#   echo "GITHUB_PAT=ghp_your_token" > .env
#   docker-compose up -d --build
#
# To rebuild and restart:
#   docker-compose up -d --build
#
# To view logs:
#   docker-compose logs -f

version: "3.8"

x-runner-common: &runner-common
  build:
    context: ../..
    dockerfile: .github/docker/Dockerfile
    network: host
  image: ghcr.io/liptonj/led-matrix-builder:latest
  entrypoint: ["/entrypoint-runner.sh"]
  restart: always
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    # Persistent cache volumes for faster builds
    - runner-cache-pio:/root/.platformio
    - runner-cache-pip:/root/.cache/pip
    - runner-cache-npm:/root/.npm
    - runner-cache-pnpm:/root/.local/share/pnpm
  networks:
    - runners
  # Resource limits - Very light for 4-core, 8GB host
  # Total for 7 runners: ~3.5 cores, 7 GB RAM
  # Only 3-4 runners will be active at once due to limits
  deploy:
    resources:
      limits:
        memory: 4G         # 1GB RAM per runner
      reservations:
        memory: 512M       # Reserve at least 512MB RAM
  environment: &runner-env
    REPO_URL: https://github.com/liptonj/Led-Matrix-Webex
    ACCESS_TOKEN: ${GITHUB_PAT}
    RUNNER_WORKDIR: /tmp/github-runner
    LABELS: self-hosted,linux,x64,docker
    RUNNER_SCOPE: repo
    DISABLE_AUTO_UPDATE: "true"
    RUN_AS_ROOT: "true"
    # Cache directories
    PLATFORMIO_CORE_DIR: /root/.platformio
    PIP_CACHE_DIR: /root/.cache/pip
    NPM_CONFIG_CACHE: /root/.npm
    PNPM_HOME: /root/.local/share/pnpm

networks:
  runners:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

services:
  runner-1:
    <<: *runner-common
    container_name: led-matrix-runner-1
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-1

  runner-2:
    <<: *runner-common
    container_name: led-matrix-runner-2
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-2

  runner-3:
    <<: *runner-common
    container_name: led-matrix-runner-3
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-3

  runner-4:
    <<: *runner-common
    container_name: led-matrix-runner-4
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-4

  runner-5:
    <<: *runner-common
    container_name: led-matrix-runner-5
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-5

  runner-6:
    <<: *runner-common
    container_name: led-matrix-runner-6
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-6

  runner-7:
    <<: *runner-common
    container_name: led-matrix-runner-7
    environment:
      <<: *runner-env
      RUNNER_NAME: led-matrix-runner-7

# Persistent cache volumes shared across all runners
# These significantly speed up builds by caching:
# - PlatformIO toolchains and libraries
# - Python pip packages
# - NPM/PNPM packages for website builds
volumes:
  runner-cache-pio:
    name: led-matrix-cache-platformio
  runner-cache-pip:
    name: led-matrix-cache-pip
  runner-cache-npm:
    name: led-matrix-cache-npm
  runner-cache-pnpm:
    name: led-matrix-cache-pnpm
